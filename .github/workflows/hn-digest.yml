# claude's daily hacker news addiction
# actually READS articles and comments, not just titles

name: hn digest

on:
  schedule:
    # asia/shanghai times (UTC+8) - adjusted for GitHub delays
    - cron: "0 23 * * *"
    - cron: "30 5 * * *"
    - cron: "45 10 * * *"
  workflow_dispatch:
    inputs:
      story_count:
        description: "stories to fetch"
        default: "15"
        type: string
      deep_dive_count:
        description: "stories to actually read"
        default: "5"
        type: string

jobs:
  read:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: fetch hacker news with content
        id: hn
        run: |
          STORY_COUNT="${{ inputs.story_count || '15' }}"
          echo "fetching top $STORY_COUNT stories with comments..."

          mkdir -p /tmp/hn

          # get top story ids
          TOP_IDS=$(curl -s "https://hacker-news.firebaseio.com/v0/topstories.json" | jq ".[:$STORY_COUNT]")

          echo "# Hacker News Top Stories" > /tmp/hn/stories.md
          echo "" >> /tmp/hn/stories.md
          echo "Fetched at: $(date -u '+%Y-%m-%d %H:%M UTC')" >> /tmp/hn/stories.md
          echo "" >> /tmp/hn/stories.md

          IDX=1
          for id in $(echo $TOP_IDS | jq -r '.[]'); do
            echo "fetching story $IDX: $id"
            STORY=$(curl -s "https://hacker-news.firebaseio.com/v0/item/$id.json")

            TITLE=$(echo $STORY | jq -r '.title // "untitled"')
            URL=$(echo $STORY | jq -r '.url // empty')
            [ -z "$URL" ] && URL="https://news.ycombinator.com/item?id=$id"
            SCORE=$(echo $STORY | jq -r '.score // 0')
            BY=$(echo $STORY | jq -r '.by // "anon"')
            COMMENTS=$(echo $STORY | jq -r '.descendants // 0')
            TIME=$(echo $STORY | jq -r '.time // 0')
            TEXT=$(echo $STORY | jq -r '.text // empty')
            KIDS=$(echo $STORY | jq -r '.kids // []')
            HN_LINK="https://news.ycombinator.com/item?id=$id"

            # write story metadata
            cat >> /tmp/hn/stories.md << STORYEOF

---

## $IDX. $TITLE

| Metric | Value |
|--------|-------|
| Score | $SCORE pts |
| Comments | $COMMENTS |
| Author | $BY |
| HN Link | $HN_LINK |
| Article | $URL |

STORYEOF

            # if it's a text post (Ask HN, Show HN), include the text
            if [ -n "$TEXT" ]; then
              echo "" >> /tmp/hn/stories.md
              echo "**Post Content:**" >> /tmp/hn/stories.md
              echo "$TEXT" | head -c 2000 >> /tmp/hn/stories.md
              echo "" >> /tmp/hn/stories.md
            fi

            # fetch top 5 comments
            COMMENT_IDS=$(echo $KIDS | jq -r '.[:5] | .[]' 2>/dev/null)
            if [ -n "$COMMENT_IDS" ]; then
              echo "" >> /tmp/hn/stories.md
              echo "**Top Comments:**" >> /tmp/hn/stories.md
              echo "" >> /tmp/hn/stories.md

              for cid in $COMMENT_IDS; do
                COMMENT=$(curl -s "https://hacker-news.firebaseio.com/v0/item/$cid.json")
                C_BY=$(echo $COMMENT | jq -r '.by // "anon"')
                C_TEXT=$(echo $COMMENT | jq -r '.text // ""' | head -c 500)
                if [ -n "$C_TEXT" ]; then
                  echo "> **$C_BY:** $C_TEXT" >> /tmp/hn/stories.md
                  echo "" >> /tmp/hn/stories.md
                fi
              done
            fi

            # try to fetch article content (first 3 stories only to save time)
            if [ $IDX -le 3 ] && [ -n "$URL" ] && [[ "$URL" != *"news.ycombinator.com"* ]]; then
              echo "fetching article content: $URL"
              ARTICLE=$(curl -sL --max-time 10 "$URL" 2>/dev/null | \
                sed 's/<script[^>]*>.*<\/script>//g' | \
                sed 's/<style[^>]*>.*<\/style>//g' | \
                sed 's/<[^>]*>//g' | \
                tr -s ' \n' ' ' | \
                head -c 3000)

              if [ -n "$ARTICLE" ]; then
                echo "" >> /tmp/hn/stories.md
                echo "**Article Preview:**" >> /tmp/hn/stories.md
                echo "$ARTICLE" >> /tmp/hn/stories.md
                echo "" >> /tmp/hn/stories.md
              fi
            fi

            IDX=$((IDX + 1))
          done

          echo "" >> /tmp/hn/stories.md
          echo "---" >> /tmp/hn/stories.md
          echo "*Raw data for Claude to analyze*" >> /tmp/hn/stories.md

          # show what we got
          wc -l /tmp/hn/stories.md
          head -100 /tmp/hn/stories.md

      - name: setup git
        run: |
          git config user.name "claude-hn-bot"
          git config user.email "claude-hn@users.noreply.github.com"

      - name: let claude curate
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          mode: agent
          model: sonnet
          allowed_tools: "Bash(git:*),Bash(gh:*),Bash(date:*),Bash(mkdir:*),Read,Write,Edit,WebFetch"
          direct_prompt: |
            You're Claude, the HN curator. You have ACCESS TO THE ACTUAL CONTENT - use it!

            ## YOUR DATA

            Read /tmp/hn/stories.md - it contains:
            - Story titles, scores, authors
            - HN discussion links
            - Article links
            - Top comments from HN discussions
            - Article previews (for top 3 stories)

            ## YOUR JOB

            Create a USEFUL digest that humans will actually want to read:

            1. **CURATE** - Pick the 5 most interesting stories based on:
               - High engagement (score + comments)
               - Interesting discussions in comments
               - Actually newsworthy content
               - Mix of topics (don't pick 5 Rust articles)

            2. **SUMMARIZE** - For each picked story:
               - What's the actual news/content (from article preview if available)
               - Why it's interesting
               - Best comment or discussion highlight
               - Your spicy take (brief, funny)

            3. **CREATE ISSUE** - Make a GitHub issue that's actually useful:
               - Title: "HN Daily: [catchy summary of top story]"
               - Body with:
                 - Quick links section (all story links)
                 - Your curated picks with summaries
                 - "Worth Reading" vs "Skip Unless Bored" sections
                 - One-liner roast of the day's vibe

            ## OUTPUT

            1. Write digest to: digests/YYYY/MM/DD-HHMM.md (use current UTC time)
               Format:
               ```
               # HN Digest - DATE TIME UTC

               ## Quick Links
               1. [Title](hn_link) - Score pts, Comments comments
               ...

               ## Editor's Picks (Claude's Curated Selection)

               ### 1. [Title](link)
               **Why it matters:** [actual summary from content]
               **Best comment:** [quote interesting discussion]
               **Hot take:** [your brief spicy opinion]

               ...

               ## Worth Reading
               - [Story](link) - brief reason

               ## Skip Unless Bored
               - [Story](link) - why it's skippable

               ## TL;DR
               [One sentence vibe check]
               ```

            2. Git add, commit, push

            3. Create GitHub issue:
               ```bash
               gh issue create \
                 --title "HN Daily: [catchy title based on top story]" \
                 --body "[your curated content with links]"
               ```

            BE USEFUL. BE FUNNY. HAVE OPINIONS. READ THE ACTUAL CONTENT.

      - name: bark
        env:
          BARK_SERVER: ${{ secrets.BARK_SERVER }}
          BARK_KEY: ${{ secrets.BARK_KEY }}
        run: |
          [ -z "$BARK_SERVER" ] || [ -z "$BARK_KEY" ] && exit 0
          curl -fsSL https://raw.githubusercontent.com/thevibeworks/yolo-tools/main/src/bin/barkme.sh -o /tmp/barkme.sh
          chmod +x /tmp/barkme.sh
          NOW=$(TZ="Asia/Shanghai" date "+%H:%M")
          /tmp/barkme.sh -R 3 -t "HN @ $NOW" -g "hn" "claude curated the news" || true
